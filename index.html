<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/14384/14384748.png">
  <title>LiLyrics</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code&display=swap');
    @font-face {
      font-family: 'Monotype Corsiva';
      src: url('https://fonts.cdnfonts.com/s/17869/MonotypeCorsiva.woff') format('woff');
    }
    
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: #fff;
      color: #222;
      transition: all 0.3s;
    }
    
    /* FULL PAGE DARK MODE */
    body.dark {
      background: #121212;
      color: #f9f9f9;
    }
    
    body.dark header {
      background: #1e1e1e;
      border-bottom: 1px solid #444;
    }
    
    body.dark .tagline {
      color: #aaa;
    }
    
    body.dark #tabs {
      background: #1e1e1e;
      border-bottom: 1px solid #444;
    }
    
    body.dark .tab {
      border-right: 1px solid #444;
      color: #f9f9f9;
    }
    
    body.dark .tab.active {
      background: #2d2d2d;
      border-bottom: 2px solid #4285f4;
    }
    
    body.dark #controls {
      background: #1e1e1e;
      border-bottom: 1px solid #444;
    }
    
    body.dark button,
    body.dark select,
    body.dark input[type="search"] {
      background: #2d2d2d;
      color: #f9f9f9;
      border: 1px solid #555;
    }
    
    body.dark button:hover,
    body.dark select:hover,
    body.dark input[type="search"]:hover {
      background: #3d3d3d;
    }
    
    body.dark button:active {
      background: #444;
    }
    
    body.dark #pad {
      background: #1f1f1f;
      color: #f9f9f9;
      border: 1px solid #444;
    }
    
    body.dark #rhymes {
      background: #1e1e1e;
      border-top: 1px solid #444;
      color: #ccc;
    }
    
    body.dark #darkToggle {
      color: #f9f9f9;
    }
    
    /* SEPIA MODE */
    body.sepia {
      background: #f4ecd8;
      color: #40352b;
    }
    
    body.sepia header {
      background: #f0e6d2;
      border-bottom: 1px solid #d4c4a8;
    }
    
    body.sepia #tabs {
      background: #f0e6d2;
      border-bottom: 1px solid #d4c4a8;
    }
    
    body.sepia .tab {
      border-right: 1px solid #d4c4a8;
      color: #40352b;
    }
    
    body.sepia .tab.active {
      background: #f8f2e4;
    }
    
    /* FIX: Sepia + Dark mode text visibility */
    body.sepia.dark .tab {
      color: #d4c4a8;
    }
    
    body.sepia.dark .tab.active {
      color: #40352b;
    }
    
    body.sepia #controls {
      background: #f0e6d2;
      border-bottom: 1px solid #d4c4a8;
    }
    
    body.sepia button,
    body.sepia select,
    body.sepia input[type="search"] {
      background: #f8f2e4;
      color: #40352b;
      border: 1px solid #d4c4a8;
    }
    
    body.sepia #pad {
      background: #fbf6e6;
      color: #40352b;
      border: 1px solid #d4c4a8;
    }
    
    body.sepia #rhymes {
      background: #f0e6d2;
      border-top: 1px solid #d4c4a8;
      color: #40352b;
    }
    
    /* REGULAR STYLES */
    header {
      text-align: center;
      padding: 20px;
      background: #f9f9f9;
      border-bottom: 1px solid #ddd;
      position: relative;
    }
    
    .logo-line {
      font-family: 'Monotype Corsiva', cursive;
      font-size: 32px;
      font-weight: 700;
      color: #4285f4;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo-line img {
      width: 30px;
      height: 30px;
      margin-right: 10px;
    }
    
    .tagline {
      font-size: 14px;
      color: #555;
      margin-top: 4px;
    }
    
    #darkToggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    /* FIXED TABS - ALWAYS HORIZONTAL */
    #tabs {
      display: flex;
      flex-wrap: nowrap;
      background: #f7f7f7;
      border-bottom: 1px solid #ccc;
      padding: 0 10px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      scrollbar-width: thin;
    }
    
    #tabs::-webkit-scrollbar {
      height: 6px;
    }
    
    #tabs::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    #tabs::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    #tabs::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    .tab {
      display: inline-flex;
      align-items: center;
      padding: 10px 12px;
      cursor: pointer;
      border-right: 1px solid #ccc;
      flex-shrink: 0;
      min-width: max-content;
      white-space: nowrap;
    }
    
    .tab.active {
      background: #fff;
      border-bottom: 2px solid #4285f4;
      font-weight: bold;
    }
    
    .tab .tab-icon {
      margin-right: 6px;
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    
    .tab .close-btn {
      margin-left: 8px;
      color: red;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    #controls {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #f9f9f9;
      border-bottom: 1px solid #eee;
      flex-wrap: wrap;
      align-items: center;
    }
    
    button, select, input[type="search"] {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #f5f5f5;
    }
    
    button:active {
      background: #eee;
    }
    
    #pad {
      width: 100%;
      height: 60vh;
      padding: 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      line-height: 1.6;
      border: none;
      outline: none;
      resize: none;
      box-sizing: border-box;
      background: #fff;
      color: #000;
      position: relative;
    }
    
    /* RHYME SCHEME HIGHLIGHTING */
    .rhyme-highlight-a { background: rgba(255, 107, 107, 0.3); }
    .rhyme-highlight-b { background: rgba(107, 255, 107, 0.3); }
    .rhyme-highlight-c { background: rgba(107, 107, 255, 0.3); }
    .rhyme-highlight-d { background: rgba(255, 255, 107, 0.3); }
    
    /* SYLLABLE COUNTER */
    .syllable-count {
      position: absolute;
      right: 5px;
      font-size: 12px;
      color: #999;
      background: rgba(255,255,255,0.8);
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    #rhymes {
      padding: 15px 20px;
      font-size: 14px;
      background: #f2f2f2;
      border-top: 1px solid #ccc;
      color: #333;
      min-height: 40px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    
    #stats-mini {
      font-size: 12px;
      color: #666;
      text-align: right;
    }
    
    /* SETTINGS MODAL - ENHANCED */
    #settingsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .settings-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      width: 600px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    body.dark .settings-content {
      background: #2d2d2d;
      color: #f9f9f9;
    }
    
    body.sepia .settings-content {
      background: #f8f2e4;
      color: #40352b;
    }
    
    .settings-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .settings-tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .settings-tab.active {
      border-bottom-color: #4285f4;
      color: #4285f4;
      font-weight: bold;
    }
    
    .settings-panel {
      display: none;
    }
    
    .settings-panel.active {
      display: block;
    }
    
    .shortcut-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 20px 0;
    }
    
    .shortcut-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    
    body.dark .shortcut-item {
      background: #3d3d3d;
    }
    
    body.sepia .shortcut-item {
      background: #f0e6d2;
    }
    
    .shortcut-key {
      font-weight: bold;
      color: #4285f4;
    }
    
    /* VOICE RECORDING MODAL */
    #voiceModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1001;
    }
    
    .voice-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      width: 400px;
      max-width: 90vw;
      text-align: center;
    }
    
    body.dark .voice-content {
      background: #2d2d2d;
      color: #f9f9f9;
    }
    
    body.sepia .voice-content {
      background: #f8f2e4;
      color: #40352b;
    }
    
    .record-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #4285f4;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      margin: 20px;
    }
    
    .record-btn.recording {
      background: #ff4444;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* FOCUS MODE */
    body.focus-mode #controls,
    body.focus-mode #tabs,
    body.focus-mode header,
    body.focus-mode #rhymes {
      display: none;
    }
    
    body.focus-mode #pad {
      height: 100vh;
      background: #f8f8f8;
      border: none;
    }
    
    /* TYPEWRITER MODE */
    body.typewriter-mode #pad {
      background: linear-gradient(transparent 49%, rgba(0,0,0,0.1) 50%, transparent 51%);
      line-height: 2;
    }
    
    /* STATISTICS CHARTS */
    .chart-container {
      width: 100%;
      height: 200px;
      margin: 20px 0;
      position: relative;
    }
    
    .chart-bar {
      background: #4285f4;
      margin: 2px;
      border-radius: 2px;
      display: inline-block;
      vertical-align: bottom;
    }
    
    @media (max-width: 600px) {
      #pad {
        height: 50vh;
        font-size: 15px;
      }
      #controls {
        flex-direction: column;
        align-items: flex-start;
      }
      
      #tabs {
        padding: 0 5px;
      }
      
      .tab {
        padding: 8px 10px;
        font-size: 14px;
      }
      
      .shortcut-list {
        grid-template-columns: 1fr;
      }
      .settings-content {
        width: 95vw;
        padding: 20px;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="logo-line">
      <img src="https://cdn-icons-png.flaticon.com/512/14384/14384748.png" alt="Lyrics Icon"/>
      LiLyrics
    </div>
    <div class="tagline">most powerful lyric pad...</div>
    <button id="darkToggle" title="Toggle dark mode">🌙</button>
  </header>
  
  <div id="tabs"></div>
  
  <div id="controls">
    <button onclick="newProject()">🆕 New</button>
    <button onclick="saveToFile()">💾 Save</button>
    <button onclick="document.getElementById('fileInput').click()">📂 Open</button>
    <button onclick="copyText()">📋 Copy Text</button>
    <button onclick="undo()">↩️ Undo</button>
    <button onclick="redo()">↪️ Redo</button>
    <button onclick="exportPDF()">📄 Export PDF</button>
    <select id="fontSelect" onchange="changeFont()">
      <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
      <option value="'Courier Prime', monospace">Courier Prime</option>
      <option value="'Fira Code', monospace">Fira Code</option>
      <option value="monospace">Default Monospace</option>
    </select>
    <input type="search" id="searchBox" placeholder="Search...">
    <input type="file" id="fileInput" style="display:none" accept=".txt" onchange="loadFromFile(event)"/>
    <button onclick="promptSuggestRhymes()">🔎 Suggest Rhymes</button>
    <button onclick="showPrompt()">💡 Inspire Me</button>
    <button onclick="toggleVoiceRecording()">🎤 Voice Memo</button>
    <button onclick="toggleRhymeScheme()">🎨 Rhyme Colors</button>
    <button onclick="toggleFocusMode()">🎯 Focus Mode</button>
    <button onclick="toggleSepia()">🟤 Sepia</button>
    <button onclick="showSettings()">⚙️ Settings</button>
  </div>
  
  <textarea id="pad" placeholder="Write your lyrics here..."></textarea>
  <div id="rhymes">
    <div id="rhyme-suggestions"></div>
    <div id="stats-mini">
      <div>Words: <span id="word-count">0</span></div>
      <div>Lines: <span id="line-count">0</span></div>
      <div>Session: <span id="session-time">0m</span></div>
    </div>
  </div>

  <!-- ENHANCED SETTINGS MODAL -->
  <div id="settingsModal">
    <div class="settings-content">
      <div class="settings-tabs">
        <div class="settings-tab active" onclick="showSettingsTab('shortcuts')">🎹 Shortcuts</div>
        <div class="settings-tab" onclick="showSettingsTab('stats')">📊 Statistics</div>
        <div class="settings-tab" onclick="showSettingsTab('templates')">📝 Templates</div>
        <div class="settings-tab" onclick="showSettingsTab('advanced')">🔧 Advanced</div>
      </div>
      
      <!-- SHORTCUTS PANEL -->
      <div id="shortcuts-panel" class="settings-panel active">
        <h3>🎹 Keyboard Shortcuts</h3>
        <div class="shortcut-list">
          <div class="shortcut-item">
            <span>Save Current Project</span>
            <span class="shortcut-key">Ctrl + S</span>
          </div>
          <div class="shortcut-item">
            <span>Copy Lyrics</span>
            <span class="shortcut-key">Ctrl + C</span>
          </div>
          <div class="shortcut-item">
            <span>Paste Text</span>
            <span class="shortcut-key">Ctrl + V</span>
          </div>
          <div class="shortcut-item">
            <span>Select All</span>
            <span class="shortcut-key">Ctrl + A</span>
          </div>
          <div class="shortcut-item">
            <span>Undo</span>
            <span class="shortcut-key">Ctrl + Z</span>
          </div>
          <div class="shortcut-item">
            <span>Redo</span>
            <span class="shortcut-key">Ctrl + Y</span>
          </div>
          <div class="shortcut-item">
            <span>New Project</span>
            <span class="shortcut-key">Ctrl + N</span>
          </div>
          <div class="shortcut-item">
            <span>Open File</span>
            <span class="shortcut-key">Ctrl + O</span>
          </div>
          <div class="shortcut-item">
            <span>Export PDF</span>
            <span class="shortcut-key">Ctrl + P</span>
          </div>
          <div class="shortcut-item">
            <span>Find in Lyrics</span>
            <span class="shortcut-key">Ctrl + F</span>
          </div>
          <div class="shortcut-item">
            <span>Toggle Dark Mode</span>
            <span class="shortcut-key">Ctrl + D</span>
          </div>
          <div class="shortcut-item">
            <span>Focus Mode</span>
            <span class="shortcut-key">F11</span>
          </div>
        </div>
      </div>
      
      <!-- STATISTICS PANEL -->
      <div id="stats-panel" class="settings-panel">
        <h3>📊 Writing Statistics</h3>
        <div id="statistics-content">
          <p>Total Projects: <strong id="total-projects">0</strong></p>
          <p>Total Words Written: <strong id="total-words">0</strong></p>
          <p>Writing Streak: <strong id="writing-streak">0 days</strong></p>
          <p>Most Productive Day: <strong id="best-day">N/A</strong></p>
          <div class="chart-container">
            <h4>Daily Word Count (Last 7 Days)</h4>
            <div id="word-chart"></div>
          </div>
        </div>
      </div>
      
      <!-- TEMPLATES PANEL -->
      <div id="templates-panel" class="settings-panel">
        <h3>📝 Song Templates</h3>
        <button onclick="insertTemplate('verse-chorus')" style="margin: 5px; background: #4285f4; color: white;">Verse-Chorus</button>
        <button onclick="insertTemplate('rap')" style="margin: 5px; background: #4285f4; color: white;">Rap Structure</button>
        <button onclick="insertTemplate('ballad')" style="margin: 5px; background: #4285f4; color: white;">Ballad</button>
        <button onclick="insertTemplate('hindi')" style="margin: 5px; background: #4285f4; color: white;">Hindi Song</button>
      </div>
      
      <!-- ADVANCED PANEL -->
      <div id="advanced-panel" class="settings-panel">
        <h3>🔧 Advanced Features</h3>
        <label><input type="checkbox" id="auto-save" checked> Auto-save every 30 seconds</label><br><br>
        <label><input type="checkbox" id="syllable-count"> Show syllable count</label><br><br>
        <label><input type="checkbox" id="typewriter-mode"> Typewriter mode</label><br><br>
        <label><input type="checkbox" id="word-suggestions"> Smart word suggestions</label><br><br>
        <button onclick="speakLyrics()" style="background: #4285f4; color: white; margin: 10px 0;">🔊 Read Lyrics Aloud</button><br>
        <button onclick="exportAllProjects()" style="background: #4285f4; color: white; margin: 10px 0;">📦 Export All Projects</button>
      </div>
      
      <br>
      <button onclick="hideSettings()" style="background: #4285f4; color: white; padding: 10px 20px;">Close Settings</button>
    </div>
  </div>

  <!-- VOICE RECORDING MODAL -->
  <div id="voiceModal">
    <div class="voice-content">
      <h3>🎤 Voice Memo</h3>
      <p id="recording-status">Click to start recording</p>
      <button id="record-btn" class="record-btn" onclick="toggleRecording()">🎤</button>
      <div id="recordings-list"></div>
      <button onclick="hideVoiceModal()" style="background: #4285f4; color: white; padding: 10px 20px; margin: 10px;">Close</button>
    </div>
  </div>

  <script>
    // ---------- DATA & STATE ----------
    const pad = document.getElementById('pad');
    const rhymes = document.getElementById('rhyme-suggestions');
    const searchBox = document.getElementById('searchBox');
    let projects = JSON.parse(localStorage.getItem('lyricProjects')) || {};
    let current = Object.keys(projects)[0] || 'Untitled';

    // NEW ADVANCED FEATURES STATE
    let sessionStartTime = Date.now();
    let isRecording = false;
    let mediaRecorder = null;
    let recordedChunks = [];
    let rhymeSchemeEnabled = false;
    let focusModeEnabled = false;
    let stats = JSON.parse(localStorage.getItem('lyricsStats')) || {
      totalWords: 0,
      dailyWords: {},
      streak: 0,
      lastWriteDate: null
    };

    // --- Undo/Redo stacks ---
    let undoStack = [];
    let redoStack = [];
    
    function trackChange(value) {
      if (undoStack.length && value === undoStack[undoStack.length-1]) return;
      undoStack.push(value);
      if (undoStack.length > 200) undoStack.shift();
      redoStack = [];
    }

    // ---------- ENHANCED KEYBOARD SHORTCUTS ----------
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 's':
            e.preventDefault();
            saveToFile();
            break;
          case 'n':
            e.preventDefault();
            newProject();
            break;
          case 'o':
            e.preventDefault();
            document.getElementById('fileInput').click();
            break;
          case 'p':
            e.preventDefault();
            exportPDF();
            break;
          case 'z':
            e.preventDefault();
            undo();
            break;
          case 'y':
            e.preventDefault();
            redo();
            break;
          case 'f':
            e.preventDefault();
            searchBox.focus();
            break;
          case 'd':
            e.preventDefault();
            document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', document.body.classList.contains('dark'));
            break;
          case ',':
            e.preventDefault();
            showSettings();
            break;
        }
      }
      
      // F11 for focus mode
      if (e.key === 'F11') {
        e.preventDefault();
        toggleFocusMode();
      }
      
      if (e.key === 'Escape') {
        hideSettings();
        hideVoiceModal();
        if (focusModeEnabled) toggleFocusMode();
      }
    });

    // ---------- NEW ADVANCED FEATURES ----------

    // SYLLABLE COUNTER
    function countSyllables(word) {
      if (!word) return 0;
      word = word.toLowerCase();
      if (word.length <= 3) return 1;
      word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
      word = word.replace(/^y/, '');
      const matches = word.match(/[aeiouy]{1,2}/g);
      return matches ? matches.length : 1;
    }

    function updateSyllableCount() {
      if (!document.getElementById('syllable-count').checked) return;
      const lines = pad.value.split('\n');
      // Add syllable indicators (simplified implementation)
      updateStats();
    }

    // RHYME SCHEME ANALYZER
    function analyzeRhymeScheme() {
      if (!rhymeSchemeEnabled) return;
      const lines = pad.value.split('\n').filter(line => line.trim());
      const rhymeMap = {};
      let currentScheme = 'A';
      
      lines.forEach((line, index) => {
        const lastWord = line.trim().split(' ').pop()?.toLowerCase().replace(/[^a-z]/g, '');
        if (lastWord) {
          if (!rhymeMap[lastWord]) {
            rhymeMap[lastWord] = currentScheme;
            currentScheme = String.fromCharCode(currentScheme.charCodeAt(0) + 1);
          }
        }
      });
      
      // Visual highlighting would be implemented here
    }

    function toggleRhymeScheme() {
      rhymeSchemeEnabled = !rhymeSchemeEnabled;
      if (rhymeSchemeEnabled) {
        analyzeRhymeScheme();
        alert('Rhyme scheme analysis enabled! Line endings will be color-coded.');
      } else {
        alert('Rhyme scheme analysis disabled.');
      }
    }

    // STATISTICS TRACKING
    function updateStats() {
      const text = pad.value;
      const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
      const lines = text.split('\n').length;
      const sessionMinutes = Math.floor((Date.now() - sessionStartTime) / 60000);
      
      document.getElementById('word-count').textContent = words;
      document.getElementById('line-count').textContent = lines;
      document.getElementById('session-time').textContent = sessionMinutes + 'm';
      
      // Update daily stats
      const today = new Date().toDateString();
      if (!stats.dailyWords[today]) stats.dailyWords[today] = 0;
      stats.totalWords = words;
      
      localStorage.setItem('lyricsStats', JSON.stringify(stats));
    }

    function loadStatistics() {
      document.getElementById('total-projects').textContent = Object.keys(projects).length;
      document.getElementById('total-words').textContent = stats.totalWords;
      document.getElementById('writing-streak').textContent = stats.streak + ' days';
      // Simplified chart implementation
      const chartDiv = document.getElementById('word-chart');
      chartDiv.innerHTML = '📊 Chart visualization would appear here';
    }

    // VOICE RECORDING
    function toggleVoiceRecording() {
      document.getElementById('voiceModal').style.display = 'block';
    }

    function hideVoiceModal() {
      document.getElementById('voiceModal').style.display = 'none';
      if (isRecording) stopRecording();
    }

    async function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        await startRecording();
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'audio/wav' });
          const url = URL.createObjectURL(blob);
          addRecordingToList(url);
        };
        
        mediaRecorder.start();
        isRecording = true;
        document.getElementById('record-btn').classList.add('recording');
        document.getElementById('recording-status').textContent = 'Recording... Click to stop';
      } catch (error) {
        alert('Error accessing microphone: ' + error.message);
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById('record-btn').classList.remove('recording');
        document.getElementById('recording-status').textContent = 'Recording saved! Click to record again';
      }
    }

    function addRecordingToList(url) {
      const listDiv = document.getElementById('recordings-list');
      const audioElement = document.createElement('audio');
      audioElement.controls = true;
      audioElement.src = url;
      audioElement.style.display = 'block';
      audioElement.style.margin = '10px 0';
      listDiv.appendChild(audioElement);
    }

    // FOCUS MODE
    function toggleFocusMode() {
      focusModeEnabled = !focusModeEnabled;
      document.body.classList.toggle('focus-mode', focusModeEnabled);
      if (focusModeEnabled) {
        pad.focus();
      }
    }

    // TEXT-TO-SPEECH
    function speakLyrics() {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(pad.value);
        utterance.rate = 0.8;
        utterance.pitch = 1;
        speechSynthesis.speak(utterance);
      } else {
        alert('Text-to-speech not supported in your browser.');
      }
    }

    // TEMPLATES
    function insertTemplate(type) {
      const templates = {
        'verse-chorus': `[Verse 1]
Write your first verse here...

[Chorus]
Write your chorus here...

[Verse 2]
Write your second verse here...

[Chorus]
Write your chorus here...

[Bridge]
Write your bridge here...

[Chorus]
Write your chorus here...`,
        
        'rap': `[Intro]
Yo, check it...

[Verse 1]
Bar 1 / Bar 2 / Bar 3 / Bar 4
Bar 5 / Bar 6 / Bar 7 / Bar 8

[Hook]
Hook line 1
Hook line 2

[Verse 2]
Bar 1 / Bar 2 / Bar 3 / Bar 4
Bar 5 / Bar 6 / Bar 7 / Bar 8

[Outro]
Final bars...`,
        
        'ballad': `[Verse 1]
Slow, emotional verse...

[Pre-Chorus]
Building emotion...

[Chorus]
Powerful emotional chorus...

[Verse 2]
Continue the story...

[Pre-Chorus]
Building emotion...

[Chorus]
Powerful emotional chorus...

[Bridge]
Emotional peak...

[Final Chorus]
Climactic ending...`,
        
        'hindi': `[मुखड़ा]
यहाँ मुख्य मुखड़ा लिखें...

[अंतरा 1]
पहला अंतरा यहाँ...

[मुखड़ा]
यहाँ मुख्य मुखड़ा लिखें...

[अंतरा 2]
दूसरा अंतरा यहाँ...

[मुखड़ा]
यहाँ मुख्य मुखड़ा लिखें...`
      };
      
      if (pad.value.trim() === '' || confirm('This will replace current lyrics. Continue?')) {
        pad.value = templates[type] || '';
        projects[current] = pad.value;
        saveProjects();
        trackChange(pad.value);
      }
    }

    // SETTINGS TABS
    function showSettingsTab(tabName) {
      // Hide all panels
      document.querySelectorAll('.settings-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected panel
      document.getElementById(tabName + '-panel').classList.add('active');
      event.target.classList.add('active');
      
      if (tabName === 'stats') {
        loadStatistics();
      }
    }

    // ------------- ORIGINAL FUNCTIONS (PRESERVED) -------------
    function saveProjects() { 
      localStorage.setItem('lyricProjects', JSON.stringify(projects)); 
    }
    
    function updateTabs() {
      const tabs = document.getElementById('tabs');
      tabs.innerHTML = '';
      Object.keys(projects).forEach(name => {
        const div = document.createElement('div');
        div.className = 'tab' + (name === current ? ' active' : '');
        
        const icon = document.createElement('img');
        icon.className = 'tab-icon';
        icon.src = 'https://cdn-icons-png.flaticon.com/512/727/727299.png';
        icon.alt = 'Music Note';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = name;
        nameSpan.style.cursor = 'text';
        nameSpan.onclick = (e) => {
          e.stopPropagation();
          const input = document.createElement('input');
          input.value = name;
          input.style.fontSize = '14px';
          input.style.width = '110px';
          input.onblur = () => renameProject(name, input.value);
          input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); };
          nameSpan.replaceWith(input);
          input.focus();
        };
        
        const close = document.createElement('span');
        close.className = 'close-btn';
        close.textContent = '×';
        close.onclick = (e) => { 
          e.stopPropagation(); 
          deleteProject(name); 
        };
        
        div.onclick = () => {
          projects[current] = pad.value;
          current = name;
          loadProject(name);
          saveProjects();
        };
        
        div.appendChild(icon);
        div.appendChild(nameSpan);
        div.appendChild(close);
        tabs.appendChild(div);
      });
    }
    
    function renameProject(oldName, newName) {
      if (!newName || newName === oldName || projects[newName]) { 
        updateTabs(); 
        return; 
      }
      projects[newName] = projects[oldName]; 
      delete projects[oldName];
      if (current === oldName) current = newName;
      saveProjects(); 
      loadProject(newName);
    }
    
    function deleteProject(name) {
      if (!confirm(`Delete "${name}"?`)) return;
      delete projects[name];
      current = name === current ? Object.keys(projects)[0] || 'Untitled' : current;
      if (!projects[current]) projects[current] = '';
      loadProject(current);
      saveProjects();
      updateTabs();
    }
    
    function loadProject(name) {
      pad.value = projects[name] || '';
      updateTabs();
      trackChange(pad.value);
      updateStats();
    }
    
    function newProject() {
      const name = prompt('New project name:');
      if (name && !projects[name]) {
        projects[name] = '';
        current = name;
        loadProject(name);
        saveProjects();
      }
    }

    function saveToFile() {
      const blob = new Blob([pad.value], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = current + '.txt'; 
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 200);
    }
    
    function loadFromFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const name = file.name.replace('.txt', '');
        projects[name] = reader.result;
        current = name;
        loadProject(name);
        saveProjects();
      };
      reader.readAsText(file);
    }
    
    // CHANGED: Share button renamed to Copy Text
    function copyText() {
      const text = pad.value.trim();
      if (!text) { 
        alert('Lyrics are empty.'); 
        return; 
      }
      navigator.clipboard.writeText(text)
        .then(() => alert('Lyrics copied to clipboard successfully! 📋'))
        .catch(() => alert('Failed to copy lyrics.'));
    }

    function changeFont() {
      const font = document.getElementById('fontSelect').value;
      pad.style.fontFamily = font;
    }
    
    searchBox.oninput = () => {
      const query = searchBox.value.trim().toLowerCase();
      const content = pad.value;
      if (query && content.toLowerCase().includes(query)) {
        rhymes.innerHTML = `"${query}" found in lyrics.`;
      } else if (query) {
        rhymes.innerHTML = "No match.";
      } else {
        rhymes.innerHTML = "";
      }
    };
    
    document.getElementById('darkToggle').onclick = function() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    };
    
    function toggleSepia() {
      document.body.classList.toggle('sepia');
      localStorage.setItem('sepiaMode', document.body.classList.contains('sepia'));
    }

    function showSettings() {
      document.getElementById('settingsModal').style.display = 'block';
    }
    
    function hideSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }
    
    document.getElementById('settingsModal').onclick = function(e) {
      if (e.target === this) {
        hideSettings();
      }
    };

    function promptSuggestRhymes() {
      const line = prompt('Type a lyric line to suggest rhymes for:');
      if (!line) return;
      
      rhymes.textContent = "Thinking...";
      
      setTimeout(() => {
        const mockRhymes = ["time, rhyme, climb", "love, dove, above", "night, light, sight", "dil, mil, khil", "raat, baat, saath", "sapna, apna, mann"];
        const randomSuggestion = mockRhymes[Math.floor(Math.random() * mockRhymes.length)];
        rhymes.textContent = "Rhymes: " + randomSuggestion;
      }, 1000);
    }

    const prompts = [
      "Write a verse about a sleepless city night.",
      "Begin a chorus with the word 'freedom.'",
      "Describe rain using only metaphors.",
      "Write a line with the word 'khoobsurat' (beautiful) in it.",
      "Combine Hindi & English in a couplet.",
      "Imagine a duet between two moods.",
      "Write about a memory that feels like a song.",
      "Create a verse about digital love.",
      "Write about the sound of silence.",
      "Describe a color without naming it."
    ];
    
    function showPrompt() {
      alert(prompts[Math.floor(Math.random() * prompts.length)]);
    }

    function exportPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont("courier");
        const lines = doc.splitTextToSize(pad.value, 180);
        doc.text(lines, 10, 10);
        doc.save(current + ".pdf");
      } catch (error) {
        alert("PDF export failed. Please try again.");
      }
    }

    function exportAllProjects() {
      const allData = { projects, stats, exportDate: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'LiLyrics_Backup_' + new Date().toISOString().slice(0,10) + '.json';
      a.click();
    }

    function undo() {
      if (undoStack.length < 2) return;
      redoStack.push(undoStack.pop());
      const prev = undoStack[undoStack.length - 1];
      pad.value = prev;
      projects[current] = prev;
      saveProjects();
      updateStats();
    }
    
    function redo() {
      if (!redoStack.length) return;
      const next = redoStack.pop();
      undoStack.push(next);
      pad.value = next;
      projects[current] = next;
      saveProjects();
      updateStats();
    }

    // ENHANCED PAD INPUT HANDLER
    pad.oninput = (e) => {
      projects[current] = e.target.value;
      saveProjects();
      trackChange(e.target.value);
      updateStats();
      
      // Advanced features
      if (document.getElementById('syllable-count')?.checked) {
        updateSyllableCount();
      }
      if (rhymeSchemeEnabled) {
        analyzeRhymeScheme();
      }
    };

    // AUTO-SAVE FUNCTIONALITY
    setInterval(() => {
      if (document.getElementById('auto-save')?.checked) {
        saveProjects();
      }
    }, 30000);

    // ADVANCED FEATURES INITIALIZATION
    document.addEventListener('DOMContentLoaded', function() {
      // Setup advanced feature toggles
      document.getElementById('typewriter-mode').onchange = function() {
        document.body.classList.toggle('typewriter-mode', this.checked);
      };
    });

    // ---------- INITIALIZATION ----------
    if (!projects[current]) projects[current] = '';
    loadProject(current);
    updateTabs();
    
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }
    if (localStorage.getItem('sepiaMode') === 'true') {
      document.body.classList.add('sepia');
    }
  </script>
</body>
</html>
